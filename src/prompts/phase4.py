"""
Phase 4: 설교문 원고 작성 프롬프트

Phase 2의 개요와 Phase 3의 피드백을 반영하여
완성도 높은 설교 원고(30-40분 분량)를 작성합니다.
"""

from src.prompts.personas import BASE_SYSTEM_PROMPT

PHASE4_SYSTEM = BASE_SYSTEM_PROMPT + """
## Phase 4 전용 지침: 설교문 원고 작성

Phase 2의 개요와 Phase 3의 피드백을 **모두 반영**하여 완성도 높은 설교 원고를 작성합니다.
이 원고는 **목사님이 실제 강단에서 읽을 수 있는 수준**이어야 합니다.

### 문장 작성 원칙

1. **짧고 간결한 문장**: 한 문장에 하나의 의미만 담습니다.
2. **능동적이고 현재형**: "~해야 할 것입니다" 대신 "~합니다", "~하세요"
3. **청중과의 대화체**: "여러분, 우리 함께 생각해봅시다"
4. **성경 인용 형식**: [책이름 장:절 "인용 내용"]
5. **신학 용어**: 처음 사용 시 반드시 일상 언어로 설명 ("성화, 즉 하나님을 닮아가는 여정은...")

### 원고 구조 및 시간 배분

- **서론** (5-7분): 훅(Hook) → 배경(Context) → 주제 제시(Thesis)
- **대지 1** (7-10분): 원어 분석 및 신학적 재정의
- **대지 2** (7-10분): 기독론적/사중복음적 확장
- **대지 3** (7-10분): 구체적 적용 (페르소나별 맞춤)
- **결론** (5-7분): 요약 → 결단과 도전 → 기도문

### 비유와 예화 원칙
- 현대적이고 공감 가능한 예시만 사용
- 4인 페르소나 모두가 공감할 수 있는 범용적 소재
- 너무 길지 않은 간결한 예화

### Phase 3 피드백 반영 원칙
Phase 3의 피드백은 **참고 자료**로 활용하되, 원고에 직접 인용하거나 페르소나 이름을 언급하지 마세요.

- **자연스러운 통합**: 피드백에서 지적된 약점은 원고 속에 자연스럽게 보완하세요.
- **신학적 보완**: 사중복음 요소의 통합 측면에서 피드백이 있다면, 교리를 억지로 열거하지 말고 설교 흐름 속에서 한 단락으로 생명력 있게 풍성하게 발전시키세요.
- **브릿지 언어**: Phase 3에서 제안된 일상 언어 표현을 원고에 자연스럽게 녹여 사용하세요.
- **청중 공감**: 다양한 청중이 공감할 수 있도록 예화와 적용을 풍성하게 하되, 특정 페르소나에게 답변하는 형태는 절대 사용하지 마세요.
- **목회적 방어**: 복음의 날카로움이 유지되도록 하되, 이를 별도 섹션이 아닌 원고 흐름 속에 자연스럽게 포함하세요.
- **공동체적 적용**: 대지 3 말미에 개인 적용과 별도로, 소그룹/구역/예배 공동체가 **함께** 실천할 수 있는 제안을 1~2문장으로 자연스럽게 추가하세요. (강요하지 않고 은혜롭게 초대하는 어조로)

> ⚠️ 절대 금지: "지혜가 지적한 대로...", "준서의 질문에 답하면...", "민수를 위해..." 등
> 페르소나 이름이나 피드백 항목을 직접 언급하는 것은 금지합니다.
> 설교 원고는 오직 청중을 향한 자연스러운 말씀이어야 합니다.

### 5대 핵심 질문 (자가 점검)
1. 메시지가 한 문장으로 명료한가?
2. 왜 지금 이 내용을 알아야 하는가? (당위성)
3. '아주 작은 행동'이 제시되었는가? (적용)
4. 복음적 이유가 충분한가? (근거)
5. 기억에 남을 키워드/이미지가 있는가? (기억 장치)

### 출력 형식

원고 형태로 자연스럽게 작성하되, 다음 구분자로 구조를 표시합니다:

```
═══════════════════════════════════════════
      설교 원고: "[설교 제목]"
═══════════════════════════════════════════

📖 본문: [성경 구절]
📌 주제: [설교 주제]
⏱️ 예상 시간: 30-40분

───────────────────────────────────────────
서론
───────────────────────────────────────────

[자연스러운 설교 원고 형태로 작성]

───────────────────────────────────────────
대지 1: [제목]
───────────────────────────────────────────

[자연스러운 설교 원고 형태로 작성]

───────────────────────────────────────────
대지 2: [제목]
───────────────────────────────────────────

[자연스러운 설교 원고 형태로 작성]

───────────────────────────────────────────
대지 3: [제목]
───────────────────────────────────────────

[자연스러운 설교 원고 형태로 작성]

───────────────────────────────────────────
결론
───────────────────────────────────────────

[요약]

[결단과 도전]

[기도문]

═══════════════════════════════════════════

📋 5대 핵심 질문 점검:
1. 메시지 명료성: ✅/⚠️ [판정 및 근거]
2. 당위성: ✅/⚠️ [판정 및 근거]
3. 작은 행동: ✅/⚠️ [판정 및 근거]
4. 복음적 근거: ✅/⚠️ [판정 및 근거]
5. 기억 장치: ✅/⚠️ [핵심 키워드/이미지]
```
"""


def get_phase4_prompt(
    phase2_result: str,
    phase3_result: str,
    sermon_context: str | None = None,
    sermon_tone: str = "일상",
    sermon_duration: str = "40",
    sermon_audience: str = "일반",
    sermon_feedback: str = "",
) -> str:
    """Phase 4 사용자 프롬프트를 생성합니다.

    Args:
        phase2_result:   Phase 2에서 생성된 설교 개요 전문.
        phase3_result:   Phase 3에서 생성된 피드백 보고서 전문.
        sermon_context:  이번 주 성도들의 삶의 상황 (선택)
        sermon_tone:     설교 어조. 도전/위로/교육/일상
        sermon_duration: 설교 예상 시간(분).
        sermon_audience: 대상 청중. 일반/어르신/청소년/새신자전용
        sermon_feedback: 목사님 스타일 선호도 피드백 (8순위)

    Returns:
        Gemini에 보낼 사용자 프롬프트 문자열.
    """
    # 톤별 추가 지침
    tone_guide = {
        "도전": "강한 회개와 결단의 촉구를 전면에 내세우세요. 죄의 심각성과 변화의 긴박함이 느껴져야 합니다.",
        "위로": "부드럽고 따뜻한 어조로 은혜와 공감을 중심에 두세요. 상처 입은 마음을 어루만지는 방식으로 작성하세요.",
        "교육": "원어 분석과 신학적 깊이를 강조하세요. 논리적 흐름과 배움의 즐거움이 느껴지도록 구성하세요.",
        "일상": "생활 밀착형 대화체로 작성하세요. 출퇴근, 직장, 가정 등 한국 성도의 Monday morning 삶과 연결하세요.",
    }
    active_tone_guide = tone_guide.get(sermon_tone, tone_guide["일상"])

    # 이번 주 상황 블록
    context_block = ""
    if sermon_context:
        context_block = f"""
📌 이번 주 성도들의 삶의 상황:
{sermon_context}
→ 서론 Hook과 대지 3 적용에 위 상황을 자연스럽게 반영하여 '우리 이야기'처럼 느껴지게 하세요.
"""

    # 청중별 추가 지침
    audience_guide = {
        "일반": "",  # 괰별 없음
        "어르신": "어른 신자들을 대상으로 합니다. 문장을 짧고 알기 쉽게, 한자어나 영어 외래어는 사용하지 마세요. 서준한 정서와 온유함 있는 팼조를 사용하세요.",
        "청소년": "청소년들을 대상으로 합니다. 자신감, 정체성, 미래에 대한 고자가 많는 나이대입니다. 그들의 세계치법과 SNS 보앙 문화를 여멸야 공감합니다. 진정성 있고 도전적인 만음으로 접근하세요.",
        "새신자전용": "신앙 초보자를 대상으로 합니다. 맨 처음 듣는 사쿨이라 생각하고 주세요. 신학 용어는 반드시 일상 언어로 설명하고, 예화는 교회 체험 없이도 이해할 수 있는 대화체로 작성하세요.",
    }
    audience_hint = audience_guide.get(sermon_audience, "")
    audience_block = f"\n👥 대상 청중: **{sermon_audience}** — {audience_hint}\n" if audience_hint else ""

    # 목사님 피드백 블록
    feedback_block = f"\n{sermon_feedback}" if sermon_feedback else ""

    return f"""
다음은 Phase 2의 설교 개요와 Phase 3의 피드백 보고서입니다.
이 모든 내용을 반영하여 완성도 높은 설교 원고를 작성해주세요.

===== Phase 2 설교 개요 =====
{phase2_result}
=============================

===== Phase 3 피드백 보고서 =====
{phase3_result}
=================================

🎙️ 설교 어조: **{sermon_tone}** — {active_tone_guide}
⏱️ 완성 분량: **{sermon_duration}분** 기준으로 원고 분량을 조절할 것
{audience_block}{context_block}{feedback_block}
반드시 다음을 포함하세요:
1. Phase 3의 피드백을 **참고하여** 약점을 보완하되, 피드백에 답변하는 형식이 아닌 자연스러운 설교 원고로 작성
2. 페르소나 이름(지혜, 준서, 민수, 수진)을 원고에 절대 언급하지 않기
3. 브릿지 언어 적극 활용 (신학 용어 + 일상 언어 병기)
4. 예화는 **한국의 일상적 생활 장면** 중심으로 (출퇴근길, 직장, 자녀 양육, 이웃 관계 등 구체적 장면 묘사)
5. 작은 행동은 WHEN(언제) + WHERE(어디서) + WHAT(무엇을) 한 문장으로 제시
6. {sermon_duration}분 기준에 맞는 원고 분량
7. 완성된 기도문
8. 5대 핵심 질문 자가 점검 결과
"""
